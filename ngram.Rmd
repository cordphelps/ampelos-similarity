---
title: "ngram
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results='hide')

# https://yihui.org/knitr/options/

# echo: (TRUE; logical or numeric) Whether to display the source code
# results: ('markup'; character) Controls how to display the text results.
# warning: (TRUE; logical) Whether to preserve warnings
# error: (TRUE; logical) Whether to preserve errors
# include: (TRUE; logical) Whether to include the chunk output in the output document.
# 
```

```{r localCode, echo=FALSE, include=FALSE}

  output.path <- "/Users/rcphelps/code/groq/output"
  setwd("/Users/rcphelps/code/groq")
    
# install.packages("tinytex")
library(tinytex)
library(tidyverse)
library(dplyr)



```

```{r plotPosterior, echo=FALSE, include=TRUE, results='asis', message=F, warning=F}

#    library(bayestestR)
# Example posterior draws from a normal distribution
#    posterior <- rnorm(1000, mean = 5, sd = 3)
# Calculate the 95% HDI (credible interval)
#    hdi_interval <- hdi(posterior, credMass = 0.95)
# Print the result
#    print(hdi_interval)

source.url <- c("./metrics/binomial-posterior-.csv")
posterior.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))

column_list <- names(posterior.tibl)
# column_list[1] is 'X' corresponding to the df index

dist1 = posterior.tibl$oakMargin.pm.week.cluster.1
dist2 = posterior.tibl$oakMargin.pm.week.cluster.2
dist3 = posterior.tibl$oakMargin.pm.week.cluster.3

dist4 = posterior.tibl$control.pm.week.cluster.1
dist5 = posterior.tibl$control.pm.week.cluster.2
dist6 = posterior.tibl$control.pm.week.cluster.3

ggplot(posterior.tibl) +
  
  geom_density(aes(x = dist1), fill = "orange", alpha = 0.6) +
  
  geom_density(aes(x = dist2), fill = "purple1", alpha = 0.6) +
  
  geom_density(aes(x = dist3), fill = "plum1", alpha = 0.6) +
  
  geom_density(aes(x = dist4), fill = "green", alpha = 0.6) +
  
  geom_density(aes(x = dist5), fill = "seagreen", alpha = 0.6) +
  
  geom_density(aes(x = dist6), fill = "palegreen", alpha = 0.6) +
  
  
  labs(title = "Density Plot of X", x = "Value", y = "Density")





```


```{r makeVariance, echo=FALSE, include=TRUE, results='asis', message=F, warning=F}

# It is critical that we don’t confuse the standard deviation and the standard error. The standard deviation is a property of the population. It tells us how much spread there is among individual observations we could make. By contrast, the standard error tells us how precisely we have determined a parameter estimate.
# The standard error is approximately given by the sample standard deviation divided by the square root of the sample size, and confidence intervals are calculated by multiplying the standard error with small, constant values.
#The correct way to assess whether there are differences in mean rating is to calculate confidence intervals for the differences. If those confidence intervals exclude zero, then we know the difference is significant at the respective confidence level. 
# Frequentists assess uncertainty with confidence intervals, whereas Bayesians calculate posterior distributions and credible intervals. The Bayesian posterior distribution tells us how likely specific parameter estimates are given the input data. The credible interval indicates a range of values in which the parameter value is expected with a given probability, as calculated from the posterior distribution. For example, a 95% credible interval corresponds to the center 95% of the posterior distribution. The true parameter value has a 95% chance of lying in the 95% credible interval.
# To summarize, a Bayesian credible interval makes a statement about the true parameter value and a frequentist confidence interval makes a statement about the null hypothesis. 
# The central goal of Bayesian estimation is to obtain the posterior distribution. Therefore, Bayesians commonly visualize the entire distribution rather than simplifying it into a credible interval.
#
# Figures with integrated titles, subtitles, and data source statements are appropriate, however, if they are meant to be used as stand-alone infographics or to be posted on social media or on a web page without accompanying caption text.
#
# https://clauswilke.com/dataviz/visualizing-uncertainty.html 
#
#

plotVariance <- function(df1, df2, t) {

  oak.tibl <- df1
  control.tibl <- df2
  time <- t
	
  gg <- ggplot() +
  
    geom_jitter(data=oak.tibl, 
                aes(y = mean, x = variance, group="SNH"),
                color = "mediumvioletred", fill = "purple1", shape = 21, size=5
                ) +
  
    geom_jitter(data=control.tibl, 
                aes(y = mean, x = variance, group="control"), 
                color = "mediumvioletred", fill = "plum1", shape = 21, size=5
                ) +
  
    #geom_text(data=oak.tibl, aes(y = mean, x = variance, label = data_label), 
    #          hjust=1, vjust = 0.5,  angle=90, size = 3) +
    #geom_text(data=control.tibl, aes(y = mean, x = variance, label = data_label), 
    #          hjust=1, vjust = 0.5, angle=90, size = 3) +

    geom_segment(aes(x=0, y=0, xend=0.3, yend=0.3)) +
  
    scale_colour_manual(name="transect", guide = 'legend', values = c("SNH"="purple1", "control"="plum1")) +
  
    scale_y_continuous(limits=c(0, 0.3) ) +
    scale_x_continuous(limits=c(0, 0.3) ) +
  
    theme_bw() +
    theme(legend.position="right") +

    # turn off legend
    # theme(legend.position="none") 

    labs( title = paste("binomial probability of spiders occurring in a sample",
                        "\nby vine position and week cluster, daytime= ", 
                        time, 
                        "\ntransect SNH is dark purple, control is light purple",
                        sep=""),
          subtitle = "checking for overdispersion; the diagonal line describes mean=variance",
          y="mean", 
          x="variance", 
          caption = paste("(points are ggplot 'jittered')", sep="" ) 
          ) 
  
    print(gg)

}

source.url <- c("./metrics/probability-variance.csv")


variance.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))

v.tibl <- variance.tibl %>% 
  dplyr::filter(time == 'am') 
  
oak.tibl <- v.tibl %>% 
  dplyr::filter(transect == 'oakMargin') 

control.tibl <- v.tibl %>% 
  dplyr::filter(transect == 'control') 

plotVariance(oak.tibl, control.tibl, t='am')

v.tible <- variance.tibl %>% 
  dplyr::filter(time == 'pm') 
  
oak.tibl <- v.tibl %>% 
  dplyr::filter(transect == 'oakMargin') 

control.tibl <- v.tibl %>% 
  dplyr::filter(transect == 'control') 

plotVariance(oak.tibl, control.tibl, t='pm')



```




```{r makeWEEK, echo=FALSE, include=TRUE, results='asis', message=F, warning=F}


source.url <- c("./metrics/week_counts_df-.csv")

# get a lot of insect observations
week.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))

pm.tibl <- week.tibl %>% 
  dplyr::filter(time == 'pm') 

# summary(pm.tibl)  # max = 15

gg <- ggplot() +
  
    geom_point(data=pm.tibl, 
                aes(y = p0, x = week, 
                colour = 4, fill = "green")
                ) +
    stat_summary(fun = mean, geom="line", size=3) + 
    stat_summary(fun.data = mean_se, geom = "errorbar") +

    scale_y_continuous(limits=c(0, 15),
                       breaks = seq(min(0), max(15), by = 1) ) +
                       
    theme_bw()  +
    # turn off legend
    theme(legend.position="none") 
  
    print(gg)



```



```{r makeNGRAM, echo=FALSE, include=TRUE, results='asis', message=F, warning=F}


source.url <- c("./metrics/transect-compare-.csv")

# get a lot of insect observations
ngram.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))

# 
pm.tibl <- ngram.tibl %>% 
  dplyr::filter(time == 'pm') %>%
  dplyr::select(julian, time, NGRAM.cosine.similarity) 

am.tibl <- ngram.tibl %>% 
  dplyr::filter(time == 'am') %>%
  dplyr::select(julian, time, NGRAM.cosine.similarity) 

```

```{r mcmc, echo=FALSE, include=TRUE, results='asis', message=F, warning=F}

# normalized poisson data
library(MCMCpack)

source.url <- c("./metrics/prob_control_df-pm_1to4_23to25-.csv")
control.pm.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))

source.url <- c("./metrics/prob_oakMargin_df-pm_1to4_23to25-.csv")
oakMargin.pm.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))


# Define log-posterior
log_post <- function(params, counts, frequencies) {
  lambda <- params[1]
  if (lambda <= 0) return(-Inf)  # Ensure positivity
  
  # Weighted log-likelihood using normalized frequencies
  log_lik <- sum(frequencies * dpois(counts, lambda, log = TRUE))
  
  # Gamma(1,1) prior for lambda
  log_prior <- dgamma(lambda, shape = 1, rate = 1, log = TRUE)
  
  return(log_lik + log_prior)
}

#df <- control.pm.tibl
df <- oakMargin.pm.tibl

posterior <- MCMCmetrop1R(
  log_post, 
  theta.init = 1, 
  burnin = 3000,
  mcmc = 50000,
  thin = 10,
  tune = 0.5,
  counts = df$count,
  frequencies = df$probability
)

# Diagnostics and visualization
library(coda)
plot(posterior)
summary(posterior)

# In summary:
# `MCMCmetrop1R` is a general-purpose tool for MCMC sampling from any user-defined posterior,
# especially useful when your model or likelihood is nonstandard or when you need to 
# incorporate custom data structures like normalized frequencies
# Diagnostics and Output
# 	•	The result is a `coda` mcmc object: use `summary(posterior)`, `plot(posterior)`, 
#     and diagnostics like `raftery.diag(posterior)`
# Notes
#	•	Alternative Distributions: Replace `dpois` with `dnbinom` (negative binomial) 
#   for overdispersed counts.
#	•	Priors: Adjust the gamma hyperparameters if you have prior knowledge about .
#	•	Efficiency: Increase `mcmc`/`burnin` if convergence is slow.

# https://search.r-project.org/CRAN/refmans/MCMCpack/html/MCMCmetrop1R.html
# https://faculty.ucr.edu/~jflegal/203/mcmcpack_huiling.html#1
# https://github.com/cran/MCMCpack/blob/master/R/MCMCmetrop1R.R
# https://andrewdmartin.washu.edu/app/uploads/2019/01/Applied-Bayesian-Inference-in-R-using-MCMCpack-2cv9ct9.pdf
# 

```

```{r graphics.2, echo=FALSE, include=TRUE, results='asis', message=F, warning=F, out.width=c('33%', '33%', '33%'), fig.show='hold'}


gg <- ggplot() +

  geom_histogram(data=am.tibl, 
                aes( 
                    y = NGRAM.cosine.similarity),
                colour = 4, fill = "white", 
                 bins = 15) +
    stat_summary(fun = mean, geom="line", size=3) + 
    stat_summary(fun.data = mean_se, geom = "errorbar") +

    scale_y_continuous(limits=c(0, 1.1),
                       breaks = seq(min(0), max(1.1), by = .2) ) +
  
    geom_histogram(data=pm.tibl, 
                aes( 
                    y = NGRAM.cosine.similarity),
                colour = 4, fill = "green", 
                 bins = 15) +
    stat_summary(fun = mean, geom="line", size=3) + 
    stat_summary(fun.data = mean_se, geom = "errorbar") +

    scale_y_continuous(limits=c(0, 1.1),
                       breaks = seq(min(0), max(1.1), by = .2) ) +

  	labs(x = "julian", y ="NGRAM.cosine.similarity", 
 				  title = paste("NGRAM.cosine.similarity",
 				                sep=""),
 				  subtitle = paste("ngram", sep=""),
 				  ) +
    
    # set default color for each group (otherwise geom_text text labels are "red")
    # https://stackoverflow.com/questions/41541708/how-to-change-font-color-in-geom-text-in-ggplot2-in-r
    # << or >>
    # https://stackoverflow.com/questions/61209218/changing-of-color-for-geom-text-gives-completely-different-color-then-called-for
    scale_colour_manual(values=c("#000000")) +
    
    coord_flip() +
    theme_bw()  +
    # turn off legend
    theme(legend.position="none") +
  
    theme(axis.text.x=element_text(angle=45,hjust=1)) 
  
    print(gg)

	

```


```{r graphics.1, echo=FALSE, include=TRUE, results='asis', message=F, warning=F, out.width=c('33%', '33%', '33%'), fig.show='hold'}


gg <- ggplot() +
  
    geom_jitter(data=pm.tibl, 
                aes(x = as.character(julian), 
                    y = NGRAM.cosine.similarity),
                    color = "black", fill = "red", 
                    shape = 25, size = 3, 
                    position = position_nudge(x = -0.1) ) +
  
    geom_jitter(data=am.tibl, 
                aes(x = as.character(julian), 
                    y = NGRAM.cosine.similarity),
                    color = "black", fill = "green", 
                    shape = 21, size = 3, 
                    position = position_nudge(x = -0.1) ) +
    stat_summary(fun = mean, geom="line", size=3) + 
    stat_summary(fun.data = mean_se, geom = "errorbar") +

    scale_y_continuous(limits=c(0, 1.1),
                       breaks = seq(min(0), max(1.1), by = .2) ) +

  	labs(x = "julian", y ="NGRAM.cosine.similarity", 
 				  title = paste("NGRAM.cosine.similarity",
 				                sep=""),
 				  subtitle = paste("ngram", sep=""),
 				  ) +
    
    # set default color for each group (otherwise geom_text text labels are "red")
    # https://stackoverflow.com/questions/41541708/how-to-change-font-color-in-geom-text-in-ggplot2-in-r
    # << or >>
    # https://stackoverflow.com/questions/61209218/changing-of-color-for-geom-text-gives-completely-different-color-then-called-for
    scale_colour_manual(values=c("#000000")) +
    
    coord_flip() +
    theme_bw()  +
    # turn off legend
    theme(legend.position="none") +
  
    theme(axis.text.x=element_text(angle=45,hjust=1)) 
  
    print(gg)

	

```

```{r saveFile, echo=FALSE, include=TRUE, results='asis', message=F, warning=F}
     
      setwd("/Users/rcphelps/code/groq/")
      
      fileName <- paste("ngram.pdf", sep="")
      wd <- getwd() 
      dirPath <- paste(wd, "/output", sep="")
      fullPath <- paste(dirPath, "/", fileName, sep="")

      if (file.exists(fullPath)) { file.remove(fullPath) }

      suppressMessages(ggsave(fileName, plot = gg, device = NULL, path = dirPath,
       scale = 1, width = 8, height = NA, dpi = 300, limitsize = TRUE,
       units = "in") )
      
      print(paste( "saved ", fullPath, sep=" "))
    
    
```  

```{r graphics.1, echo=FALSE, include=TRUE, results='asis', message=F, warning=F, out.width=c('33%', '33%', '33%'), fig.show='hold'}

source.url <- c("./metrics/row_similarity.csv")

# get a lot of insect observations
rows.tibl <- dplyr::as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))

# thrips
t1_t2.tibl <- rows.tibl %>% 
  dplyr::select(julian, time, t1_t2) 
t1_t2.tibl <- t1_t2.tibl %>% rename(ngram_similarity = t1_t2)

t2_t3.tibl <- rows.tibl %>% 
  dplyr::select(julian, time, t2_t3) 
t2_t3.tibl <- t2_t3.tibl %>% rename(ngram_similarity = t2_t3)

t1_t3.tibl <- rows.tibl %>% 
  dplyr::select(julian, time, t1_t3) 
t1_t3.tibl <- t1_t3.tibl %>% rename(ngram_similarity = t1_t3)

stacked_df <- bind_rows(t1_t2.tibl, t2_t3.tibl)

stacked_df <- bind_rows(stacked_df, t1_t3.tibl)

stacked_am.tibl <- stacked_df %>% dplyr::filter(time == 'am')
stacked_pm.tibl <- stacked_df %>% dplyr::filter(time == 'pm')

gg <- ggplot() +
  
    geom_boxplot(data=stacked_am.tibl, 
                aes(x = as.character(julian), 
                    y = ngram_similarity),
                    #color = "black", 
                    fill = "green", 
                    alpha = 0.2,
                    #shape = 21, size = 3, 
                    position = position_nudge(x = -0.2) ) +
  
    geom_boxplot(data=stacked_pm.tibl, 
                aes(x = as.character(julian), 
                    y = ngram_similarity),
                    #color = "white", 
                    fill = "blue", 
                    alpha = 0.6,
                    #shape = 21, size = 3, 
                    position = position_nudge(x = +0.2) ) +
  

    scale_y_continuous(limits=c(0, 1.1),
                       breaks = seq(min(0), max(1.1), by = .2) ) +

  	labs(x = "julian", y ="NGRAM.cosine.similarity", 
 				  title = paste("NGRAM.cosine.similarity",
 				                sep=""),
 				  subtitle = paste("ngram", sep=""),
 				  ) +
    
    # set default color for each group (otherwise geom_text text labels are "red")
    # https://stackoverflow.com/questions/41541708/how-to-change-font-color-in-geom-text-in-ggplot2-in-r
    # << or >>
    # https://stackoverflow.com/questions/61209218/changing-of-color-for-geom-text-gives-completely-different-color-then-called-for
    scale_colour_manual(values=c("#000000")) +
    
    # coord_flip() +
    theme_bw()  +
    # turn off legend
    theme(legend.position="none") +
  
    theme(axis.text.x=element_text(angle=45,hjust=1)) 
  
    print(gg)

	

```